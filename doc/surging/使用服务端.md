surging中服务端例子：
```csharp
using Autofac;
using Surging.Core.Caching;
using Surging.Core.Caching.Configurations;
using Surging.Core.Codec.MessagePack;
using Surging.Core.Consul;
using Surging.Core.Consul.Configurations;
using Surging.Core.CPlatform;
using Surging.Core.CPlatform.Utilities;
using Surging.Core.DotNetty;
using Surging.Core.EventBusKafka.Configurations;
//using Surging.Core.EventBusKafka;
using Surging.Core.EventBusRabbitMQ;
using Surging.Core.Log4net;
using Surging.Core.ProxyGenerator;
using Surging.Core.ServiceHosting;
using Surging.Core.ServiceHosting.Internal.Implementation;
using System;
using System.Net;
//using Surging.Core.Zookeeper;
//using Surging.Core.Zookeeper.Configurations;
using System.Text;

namespace Surging.Services.Server
{
    public class Program
    {
        static void Main(string[] args)
        {

            Encoding.RegisterProvider(CodePagesEncodingProvider.Instance);
            var host = new ServiceHostBuilder()
                .RegisterServices(builder =>
                {
                    builder.AddMicroService(option =>
                    {
                        option.AddServiceRuntime();
                        option.AddRelateService();
                        //option.UseZooKeeperManager(new ConfigInfo("127.0.0.1:2181"));
                        option.UseConsulManager(new ConfigInfo("127.0.0.1:8500"));
                        option.UseDotNettyTransport();
                        option.UseRabbitMQTransport();
                        option.AddRabbitMQAdapt();
                        option.AddCache();
                        //option.UseKafkaMQTransport(kafkaOption =>
                        //{
                        //    kafkaOption.Servers = "127.0.0.1";
                        //    kafkaOption.LogConnectionClose = false;
                        //    kafkaOption.MaxQueueBuffering = 10;
                        //    kafkaOption.MaxSocketBlocking = 10;
                        //    kafkaOption.EnableAutoCommit = false;
                        //});
                        //option.AddKafkaMQAdapt();
                        //option.UseProtoBufferCodec(); 
                        option.UseMessagePackCodec();
                        builder.Register(p => new CPlatformContainer(ServiceLocator.Current));
                    });
                })
                .SubscribeAt()
                //.UseServer("127.0.0.1", 98)
                //.UseServer("127.0.0.1", 98，“true”) //自动生成Token
                //.UseServer("127.0.0.1", 98，“123456789”) //固定密码Token
                .UseServer(options =>
                {
                    // options.IpEndpoint = new IPEndPoint(IPAddress.Any, 98);
                    options.Ip = "127.0.0.1";
                    options.Port = 98;
                    options.Token = "True";
                    options.ExecutionTimeoutInMilliseconds = 30000;
                    options.MaxConcurrentRequests = 200;
                    options.NotRelatedAssemblyFiles = "Centa.Agency.Application.DTO\\w*|StackExchange.Redis\\w*";
                })
                .UseServiceCache()
                .ConfigureServices(build =>
                build.AddEventBusFile("eventBusSettings.json", optional: false))
                .ConfigureServices(build =>
                build.AddCacheFile("cacheSettings.json", optional: false))
                .UseLog4net("Configs/log4net.config")
                .UseProxy()
                .UseStartup<Startup>()
                .Build();

            using (host.Run())
            {
                Console.WriteLine($"服务端启动成功，{DateTime.Now}。");
            }
        }
    }
}
```
先看下面扩展方法的调用：
```csharp
UseServer(options =>
{
    // options.IpEndpoint = new IPEndPoint(IPAddress.Any, 98);
    options.Ip = "127.0.0.1";
    options.Port = 98;
    options.Token = "True";
    options.ExecutionTimeoutInMilliseconds = 30000;
    options.MaxConcurrentRequests = 200;
    options.NotRelatedAssemblyFiles = "Centa.Agency.Application.DTO\\w*|StackExchange.Redis\\w*";
})
```
实现：
```csharp
public static IServiceHostBuilder UseServer(this IServiceHostBuilder hostBuilder, Action<SurgingServerOptions> options)
{
    var serverOptions = new SurgingServerOptions();
    options.Invoke(serverOptions);
    AppConfig.ServerOptions = serverOptions;
    return hostBuilder.UseServer(serverOptions.Ip,serverOptions.Port,serverOptions.Token);
}
```
实例化SurgingServerOptions，并传给委托调用，委托内进行参数设置。

`hostBuilder.UseServer(serverOptions.Ip,serverOptions.Port,serverOptions.Token)`实现：
```csharp
public static IServiceHostBuilder UseServer(this IServiceHostBuilder hostBuilder, string ip, int port, string token="True")
{
    return hostBuilder.MapServices(mapper =>
    {
        mapper.Resolve<IServiceCommandManager>().SetServiceCommandsAsync();
        var serviceEntryManager = mapper.Resolve<IServiceEntryManager>();
        string serviceToken = mapper.Resolve<IServiceTokenGenerator>().GeneratorToken(token);
        int _port = port;
        string _ip = ip;
        _port = AppConfig.ServerOptions.IpEndpoint?.Port ?? _port;
        _ip = AppConfig.ServerOptions.IpEndpoint?.Address.ToString() ?? _ip;
        if (_ip.IndexOf(".") < 0 || _ip == "" || _ip == "0.0.0.0")
        {
            NetworkInterface[] nics = NetworkInterface.GetAllNetworkInterfaces();
            foreach (NetworkInterface adapter in nics)
            {
                if (adapter.NetworkInterfaceType == NetworkInterfaceType.Ethernet && (_ip == "" || _ip == "0.0.0.0" || _ip == adapter.Name))
                {
                    IPInterfaceProperties ipxx = adapter.GetIPProperties();
                    UnicastIPAddressInformationCollection ipCollection = ipxx.UnicastAddresses;
                    foreach (UnicastIPAddressInformation ipadd in ipCollection)
                    {
                        if (ipadd.Address.AddressFamily == System.Net.Sockets.AddressFamily.InterNetwork)
                        {
                            _ip = ipadd.Address.ToString();
                        }
                    }
                }
            }
        }
        
        var addressDescriptors = serviceEntryManager.GetEntries().Select(i =>
        new ServiceRoute
        {
            Address = new[] { new IpAddressModel { Ip = _ip, Port = _port, Token= serviceToken } },
            ServiceDescriptor = i.Descriptor
        }).ToList();
        mapper.Resolve<IServiceRouteManager>().SetRoutesAsync(addressDescriptors);
        mapper.Resolve<IModuleProvider>().Initialize();
        var serviceHost = mapper.Resolve<Runtime.Server.IServiceHost>();
        Task.Factory.StartNew(async () =>
        {
            await serviceHost.StartAsync(new IPEndPoint(IPAddress.Parse(_ip), _port));
        }).Wait();
    });
}
```