ASP.NET Core 支持依赖关系注入 (DI) 软件设计模式，这是一种在类及其依赖关系之间实现控制反转 (IoC) 的技术。

### 依赖注入概述

依赖项是另一个对象所需的任何对象。

```csharp
public class MyDependency
{
    public MyDependency()
    {
    }

    public Task WriteMessage(string message)
    {
        Console.WriteLine(
            $"MyDependency.WriteMessage called. Message: {message}");

        return Task.FromResult(0);
    }
}
```

可以创建 MyDependency 类的实例以使 WriteMessage 方法可用于类。 MyDependency 类是 IndexModel 类的依赖项：

```csharp
public class IndexModel : PageModel
{
    MyDependency _dependency = new MyDependency();

    public async Task OnGetAsync()
    {
        await _dependency.WriteMessage(
            "IndexModel.OnGetAsync created this message.");
    }
}
```
该类创建并直接依赖于 MyDependency 实例。 代码依赖关系（如前面的示例）存在问题，应该避免使用，原因如下：

* 要用不同的实现替换 MyDependency，必须修改类。
* 如果 MyDependency 具有依赖关系，则必须由类对其进行配置。 在具有多个依赖于 MyDependency 的类的大型项目中，配置代码在整个应用中会变得分散。
* 很难进行单元测试。比如不能使用模拟的MyDependency类型进行测试。

依赖关系注入通过以下方式解决了这些问题：

* 使用接口抽象化依赖关系实现。
* 注册服务容器中的依赖关系。 ASP.NET Core 提供了一个内置的服务容器 IServiceProvider。 服务在应用的 Startup.ConfigureServices 方法中注册。
* 将服务注入到使用它的类的构造函数中。 框架负责创建依赖关系的实例，并在不再需要时对其进行处理。
>除了构造函数注入还有属性注入，接口注入。

**例子**
```csharp
public interface IMyDependency
{
    Task<string> GetMessage(string message);
}
```
```csharp
public class MyDependency : IMyDependency
{
    public Task<string> GetMessage(string message)
    {
        return Task.FromResult(message);
    }
}
```
注册到容器中
```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddScoped<IMyDependency, MyDependency>();
}
```

修改之前的中间件例子
```csharp
public async Task InvokeAsync(HttpContext context,IMyDependency myDependency)
{
    await context.Response.WriteAsync(string.Format("otherParams:{0}\r\n", _otherParams));
    await context.Response.WriteAsync(string.Format("MyDependency Message:{0}\r\n", myDependency.GetMessage("1213").Result));
    await context.Response.WriteAsync("MyMiddleware Build In Class!\r\n");
    await _next(context);//不调用next，则阻断管道
}
```

IMyDependency实例由容器自动注入

![](img/依赖关系注入/2019-01-17-11-04-19.png)

