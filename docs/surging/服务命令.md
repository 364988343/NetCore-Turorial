前面分析客户端代理调用的时候，从[ServiceCommandProvider](/surging/客户端代理调用?id=servicecommandprovider)取服务命令的时候，跳过了Zookeeper或Consul相关的逻辑。直接从本地扫描接口得到的结果中取出。
```csharp
public async Task<ServiceCommand> GetCommandAsync(string serviceId)
{
    var result = new ServiceCommand();
    var manager = _serviceProvider.GetService<IServiceCommandManager>();
    if (manager == null)
    {
        var command = (from q in _serviceEntryManager.GetEntries()
                        let k = q.Attributes
                        where k.OfType<CommandAttribute>().Count() > 0 && q.Descriptor.Id == serviceId
                        select k.OfType<CommandAttribute>().FirstOrDefault()).FirstOrDefault();
        result = ConvertServiceCommand(command);
    }
    else
    {
        var commands = await manager.GetServiceCommandsAsync();
        result = ConvertServiceCommand(commands.Where(p => p.ServiceId == serviceId).FirstOrDefault());
    }
    _serviceCommand.AddOrUpdate(serviceId, result, (s, r) => result);
    return result;
}
```
`IServiceCommandManager`的实现有`ConsulServiceCommandManager`与`ZookeeperServiceCommandManager`。

本节以ConsulServiceCommandManager为例进行分析。

### ConsulServiceCommandManager

服务命令的注册：
```csharp
public static IServiceHostBuilder UseServer(this IServiceHostBuilder hostBuilder, string ip, int port, string token="True")
{
    return hostBuilder.MapServices(mapper =>
    {
        mapper.Resolve<IServiceCommandManager>().SetServiceCommandsAsync();
        ...
        ...
        ...
    });
}
```